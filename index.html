<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ… ã‚¯ãƒªã‚¹ãƒã‚¹ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆæ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ  ğŸ</title>
<style>
  :root {
    --bg:#fff8f8; --card:#ffffff; --border:#e5e5e5; --txt:#222; --muted:#777;
    --accent-red:#e63946; --accent-green:#2a9d8f; --btn-shadow:0 4px 8px rgba(0,0,0,0.15);
    --overlay: rgba(0,0,0,.4);
  }
  body { margin:0; background:var(--bg); font-family:"Nunito","ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN","Meiryo",sans-serif; color:var(--txt); }
  .wrap { max-width:480px; margin:0 auto; padding:16px; }
  .card {
    background:var(--card); border-radius:16px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,.08);
    border:3px solid var(--accent-green); background-image: radial-gradient(circle at top left, #fff5f5, #f9fffa);
  }
  h1 { text-align:center; font-size:22px; color:var(--accent-red); margin-bottom:12px; }
  h1::after { content:"ğŸ„"; display:block; font-size:28px; margin-top:4px; }
  .row { margin:18px 0; }
  label { font-weight:600; font-size:15px; color:var(--accent-green); }
  input[type="text"], textarea {
    width:100%; padding:10px 12px; border:2px solid var(--accent-green); border-radius:10px;
    font-size:16px; box-sizing:border-box; background:#fff;
  }
  textarea { min-height:80px; resize:vertical; }
  .cat { border:2px dashed var(--accent-green); border-radius:12px; padding:12px; margin-top:14px; background:#fffefa; }
  .cat h3 { margin:0; font-size:18px; color:var(--accent-red); display:flex; align-items:center; justify-content:space-between; }
  .cat input[type="checkbox"] { width:22px; height:22px; accent-color: var(--accent-green); }
  .items { display:none; grid-template-columns:1fr auto; gap:10px 8px; margin-top:8px; }
  .item-name { font-size:15px; }
  .qty {
    width:64px; padding:6px; font-size:15px; border:1px solid var(--border); border-radius:8px; text-align:center;
  }
  .muted { color:var(--muted); font-size:12px; margin-top:4px; }
  .btn {
    width:100%; background:linear-gradient(135deg, var(--accent-red), var(--accent-green)); color:#fff; border:none;
    padding:14px; border-radius:12px; font-size:18px; cursor:pointer; box-shadow:var(--btn-shadow); transition:.2s;
  }
  .btn:hover { filter:brightness(1.1); }
  #result { margin-top:16px; font-weight:700; text-align:center; color:var(--accent-green); }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-backdrop { position:fixed; inset:0; background:var(--overlay); display:none; align-items:center; justify-content:center; padding:16px; z-index:1000; }
  .modal { background:#fff; border-radius:16px; max-width:480px; width:100%; box-shadow:0 8px 20px rgba(0,0,0,.25); border:2px solid var(--accent-green); padding:20px; }
  .modal h2 { margin:0 0 12px; color:var(--accent-red); font-size:20px; text-align:center; }
  .modal .content { max-height:50vh; overflow:auto; font-size:15px; }
  .modal .actions { display:flex; gap:10px; margin-top:16px; }
  .btn-secondary, .btn-primary { flex:1; padding:12px; border-radius:10px; font-size:16px; cursor:pointer; border:none; }
  .btn-secondary { background:#eee; color:#333; }
  .btn-primary { background:linear-gradient(135deg, var(--accent-red), var(--accent-green)); color:#fff; }
  .center { text-align:center; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ã”æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ </h1>

    <div class="row">
      <label for="customerId">ãŠå®¢æ§˜ç•ªå·ï¼ˆåŠè§’æ•°å­—ï¼‰</label>
      <input type="text" id="customerId" inputmode="numeric" pattern="[0-9]+" placeholder="ä¾‹: 123" required />
      <div class="muted">â€»åŠè§’æ•°å­—ã®ã¿ã€‚è‹±å­—ãƒ»å…¨è§’ã¯ä¸å¯ã€‚</div>
    </div>

    <!-- ã‚«ãƒ†ã‚´ãƒªï¼ˆå‹•çš„ã«æ³¨å…¥ï¼‰ -->
    <div id="categories"></div>

    <div class="row">
      <label for="note">å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
      <textarea id="note" placeholder="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã€æä¾›ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãªã©è‡ªç”±ã«è¨˜è¿°ãã ã•ã„"></textarea>
    </div>

    <button class="btn" id="submitBtn">æ³¨æ–‡å†…å®¹ç¢ºèª</button>
    <div id="result"></div>
  </div>
</div>

<!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-backdrop" id="confirmBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <h2 id="confirmTitle">æ³¨æ–‡å†…å®¹ã®ç¢ºèª</h2>
    <div class="content" id="confirmContent"></div>
    <div class="actions">
      <button class="btn-secondary" id="editBtn">æˆ»ã£ã¦ä¿®æ­£</button>
      <button class="btn-primary" id="confirmBtn">ã“ã®å†…å®¹ã§é€ä¿¡</button>
    </div>
  </div>
</div>

<!-- å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-backdrop" id="doneBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="doneTitle">
    <h2 id="doneTitle">æ³¨æ–‡ãŒå®Œäº†ã—ã¾ã—ãŸ ğŸ‰</h2>
    <div class="content center">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼<br>å—ä»˜ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</div>
    <div class="actions"><button class="btn-primary" id="okBtn">OK</button></div>
  </div>
</div>

<script>
/** â˜…Cloudflare Workers ã®URLï¼ˆâ†’ WorkersãŒGASã¸ä¸­ç¶™ï¼‰ */
const GAS_URL = "https://mute-forest-8746.matsuno12199.workers.dev/";

let PRICES = null; // GASã‹ã‚‰å–å¾—ã—ã¦ä½¿ã†

/* ====== ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾— â†’ UIæ§‹ç¯‰ ====== */
async function fetchMenu() {
  const url = GAS_URL + "?fn=menu";
  const res = await fetch(url, { method: 'GET' });
  const json = await res.json();
  if (!json.success) throw new Error(json.error || 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—ã«å¤±æ•—');
  return json.menu; // {category: {item: price}}
}

const categoriesEl = document.getElementById('categories');

function renderCategory(name, itemsObj) {
  const cat = document.createElement('div');
  cat.className = 'cat';

  const h = document.createElement('h3');
  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.id = `cat-${name}`;
  h.appendChild(checkbox);
  const label = document.createElement('span');
  label.textContent = name;
  h.appendChild(label);
  cat.appendChild(h);

  // ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰
  const items = document.createElement('div');
  items.className = 'items';

  for (const itemName of Object.keys(itemsObj)) {
    const price = itemsObj[itemName];

    const nameEl = document.createElement('div');
    nameEl.className = 'item-name';
    nameEl.textContent = `${itemName} Â¥${price}`;

    const qty = document.createElement('input');
    qty.type = 'number';
    qty.min = '0';
    qty.max = '9';
    qty.step = '1';
    qty.value = '0';
    qty.className = 'qty';
    qty.dataset.category = name;
    qty.dataset.name = itemName;

    qty.addEventListener('input', () => {
      let v = parseInt(qty.value || '0', 10);
      if (isNaN(v)) v = 0;
      if (v < 0) v = 0;
      if (v > 9) v = 9;
      qty.value = String(v);
    });

    items.appendChild(nameEl);
    items.appendChild(qty);
  }
  cat.appendChild(items);

  checkbox.addEventListener('change', () => {
    items.style.display = checkbox.checked ? 'grid' : 'none';
    if (!checkbox.checked) {
      items.querySelectorAll('input[type="number"]').forEach(inp => inp.value = '0');
    }
  });

  categoriesEl.appendChild(cat);
}

function buildUIFromPrices(prices) {
  categoriesEl.innerHTML = '';
  for (const catName of Object.keys(prices)) {
    renderCategory(catName, prices[catName]);
  }
}

/* ====== æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ä½œæˆ & åˆè¨ˆè¨ˆç®— ====== */
function pickOrders() {
  const orders = [];
  document.querySelectorAll('.qty').forEach(inp => {
    const qty = Number(inp.value || 0);
    if (qty > 0) {
      const category = inp.dataset.category;
      const name = inp.dataset.name;
      orders.push({ category, name, qty });
    }
  });
  return orders;
}
function calcTotal(orders) {
  let total = 0;
  for (const o of orders) {
    const unit = PRICES?.[o.category]?.[o.name] || 0;
    total += unit * o.qty;
  }
  return total;
}

/* ====== ãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
function openModal(backdrop) { backdrop.style.display = 'flex'; backdrop.setAttribute('aria-hidden', 'false'); }
function closeModal(backdrop) { backdrop.style.display = 'none'; backdrop.setAttribute('aria-hidden', 'true'); }
const confirmBackdrop = document.getElementById('confirmBackdrop');
const confirmContent  = document.getElementById('confirmContent');
const doneBackdrop    = document.getElementById('doneBackdrop');

/* ====== é€ä¿¡ãƒ•ãƒ­ãƒ¼ ====== */
const submitBtn = document.getElementById('submitBtn');
const editBtn   = document.getElementById('editBtn');
const confirmBtn= document.getElementById('confirmBtn');
const okBtn     = document.getElementById('okBtn');

submitBtn.addEventListener('click', () => {
  const customerId = document.getElementById('customerId').value.trim();
  if (!/^\d+$/.test(customerId)) { alert('ãŠå®¢æ§˜ç•ªå·ã¯åŠè§’æ•°å­—ã®ã¿ã§ã™'); return; }

  const orders = pickOrders();
  if (orders.length === 0) { alert('æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

  const note = document.getElementById('note').value.trim();
  const total = calcTotal(orders);

  const lines = orders.map(o => {
    const unit = PRICES[o.category][o.name];
    return `ãƒ»${o.category} / ${o.name} Ã— ${o.qty} = Â¥${(unit*o.qty).toLocaleString()}`;
  }).join('<br>');

  confirmContent.innerHTML =
    `<div><b>ãŠå®¢æ§˜ç•ªå·ï¼š</b>${customerId}</div>` +
    (note ? `<div><b>å‚™è€ƒï¼š</b>${note}</div>` : '') +
    `<hr><div>${lines}</div><hr>` +
    `<div class="center"><b>åˆè¨ˆï¼š</b>Â¥${total.toLocaleString()}</div>`;

  openModal(confirmBackdrop);
});
document.getElementById('editBtn').addEventListener('click', () => closeModal(confirmBackdrop));

document.getElementById('confirmBtn').addEventListener('click', async () => {
  closeModal(confirmBackdrop);
  const customerId = document.getElementById('customerId').value.trim();
  const orders = pickOrders();
  const note = document.getElementById('note').value.trim();

  const resultEl = document.getElementById('result');
  resultEl.textContent = 'é€ä¿¡ä¸­â€¦';

  try {
    const res = await fetch(GAS_URL, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ customerId, orders, note })
    });
    const json = await res.json();
    if (json.nonJson) {
      resultEl.innerHTML = 'ã‚µãƒ¼ãƒå´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
      return;
    }
    if (json.success) {
      resultEl.innerHTML =
        `ğŸ‰ <b>ä»Šå›ã®åˆè¨ˆï¼š</b> Â¥${Number(json.thisTotal).toLocaleString()}<br>` +
        `ğŸ’° <b>ã“ã‚Œã¾ã§ã®ç´¯è¨ˆï¼š</b> Â¥${Number(json.cumulative).toLocaleString()}`;
      openModal(doneBackdrop);
    } else {
      resultEl.textContent = 'ã‚¨ãƒ©ãƒ¼ï¼š' + (json.error || 'unknown');
    }
  } catch (err) {
    resultEl.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š' + err.message;
  }
});
document.getElementById('okBtn').addEventListener('click', () => { closeModal(doneBackdrop); resetForm(); });

function resetForm() {
  document.getElementById('customerId').value = '';
  document.getElementById('note').value = '';
  document.getElementById('result').textContent = '';
  document.querySelectorAll('.cat input[type="checkbox"]').forEach(cb => { cb.checked = false; });
  document.querySelectorAll('.items').forEach(items => {
    items.style.display = 'none';
    items.querySelectorAll('input[type="number"]').forEach(inp => inp.value = '0');
  });
}

/* ====== åˆæœŸåŒ–ï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—ã—ã¦UIç”Ÿæˆ ====== */
(async () => {
  try {
    PRICES = await fetchMenu();
    buildUIFromPrices(PRICES);
  } catch (e) {
    document.getElementById('categories').innerHTML =
      `<div class="muted">ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}</div>`;
  }
})();
</script>
</body>
</html>
